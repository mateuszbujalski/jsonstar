name: buildtest

on: 
    push:
        branches:
            - master

jobs:
    jsonstar:
        name: build
        runs-on: windows-latest
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v2
              
            - name: Add msbuild to PATH
              uses: microsoft/setup-msbuild@v1.0.2
            
            - name: Add nuget to PATH
              uses: nuget/setup-nuget@v1
            
            - name: Restore nugets
              run: nuget restore $Env:GITHUB_WORKSPACE\jsonstar.sln
              
            - name: Build code
              run: msbuild.exe $Env:GITHUB_WORKSPACE\jsonstar.sln /p:Configuration=Release
              
            - name: Run tests
              run: .\packages\NUnit.ConsoleRunner.3.11.1\tools\nunit3-console.exe .\jsonstar.test\bin\Release\jsonstar.test.dll
              
            - name: Bump version in jsonstar.nuspec
              uses: remorses/bump-version@js
              with:
                  version_file: .\jsonstar\jsonstar.nuspec
                  github_token: ${{ secrets.GITHUB_TOKEN }}
              
            - name: Create nuget
              run: nuget pack .\jsonstar\jsonstar.nuspec
              
            - name: Publish nuget
              run: nuget push .\jsonstar\jsonstar.*.nupkg ${{ secrets.GITHUB_TOKEN }} -Source https://nuget.pkg.github.com/mateuszbujalski/index.json